const keysEn = 
'<div class="key" data-code="Backquote">`</div>   '+`
<div class="key" data-code="Digit1">1</div>
<div class="key" data-code="Digit2">2</div>
<div class="key" data-code="Digit3">3</div>
<div class="key" data-code="Digit4">4</div>
<div class="key" data-code="Digit5">5</div>
<div class="key" data-code="Digit6">6</div>
<div class="key" data-code="Digit7">7</div>
<div class="key" data-code="Digit8">8</div>
<div class="key" data-code="Digit9">9</div>
<div class="key" data-code="Digit0">0</div>
<div class="key" data-code="Minus">-</div>
<div class="key" data-code="Equal">=</div>
<div class="key hot" data-code="Backspace">Backspace</div>
<div class="key hot" data-code="Tab">Tab</div>
<div class="key" data-code="KeyQ">q</div>
<div class="key" data-code="KeyW">w</div>
<div class="key" data-code="KeyE">e</div>
<div class="key" data-code="KeyR">r</div>
<div class="key" data-code="KeyT">t</div>
<div class="key" data-code="KeyY">y</div>
<div class="key" data-code="KeyU">u</div>
<div class="key" data-code="KeyI">i</div>
<div class="key" data-code="KeyO">o</div>
<div class="key" data-code="KeyP">p</div>
<div class="key" data-code="BracketLeft">[</div>
<div class="key" data-code="BracketRight">]</div> 
<div class="key" data-code="Backslash">\\</div> 
<div class="key hot" data-code="Delete">DEL</div>
<div class="key hot" data-code="CapsLock">Caps Lock</div>
<div class="key" data-code="KeyA">a</div>
<div class="key" data-code="KeyS">s</div>
<div class="key" data-code="KeyD">d</div>
<div class="key" data-code="KeyF">f</div>
<div class="key" data-code="KeyG">g</div>
<div class="key" data-code="KeyH">h</div>
<div class="key" data-code="KeyJ">j</div>
<div class="key" data-code="KeyK">k</div>
<div class="key" data-code="KeyL">l</div>
<div class="key" data-code="Semicolon">;</div>
<div class="key" data-code="Quote">'</div>
<div class="key hot" data-code="Enter">ENTER</div>
<div class="key hot" data-code="ShiftLeft">Shift</div>
<div class="key" data-code="KeyZ">z</div>
<div class="key" data-code="KeyX">x</div>
<div class="key" data-code="KeyC">c</div>
<div class="key" data-code="KeyV">v</div>
<div class="key" data-code="KeyB">b</div>
<div class="key" data-code="KeyN">n</div>
<div class="key" data-code="KeyM">m</div>
<div class="key" data-code="Period">.</div>
<div class="key" data-code="Comma">,</div>
<div class="key" data-code="Slash">/</div>
<div class="key hot" data-code="ArrowUp">△</div>
<div class="key hot" data-code="ShiftRight">Shift</div>
<div class="key hot" data-code="ControlLeft">Ctrl</div>
<div class="key hot" data-code="MetaLeft">Meta</div>
<div class="key hot" data-code="AltLeft">Alt</div>
<div class="key" data-code="Space"></div>
<div class="key hot" data-code="AltRight">Alt</div>
<div class="key hot" data-code="ControlRight">Ctrl</div>
<div class="key hot" data-code="ArrowLeft">◁</div>
<div class="key hot" data-code="ArrowDown">▽</div>
<div class="key hot" data-code="ArrowRight">▷</div>
`;

const keysEnShift = `
<div class="key" data-code="Backquote">~</div>
<div class="key" data-code="Digit1">!</div>
<div class="key" data-code="Digit2">@</div>
<div class="key" data-code="Digit3">#</div>
<div class="key" data-code="Digit4">$</div>
<div class="key" data-code="Digit5">%</div>
<div class="key" data-code="Digit6">^</div>
<div class="key" data-code="Digit7">&</div>
<div class="key" data-code="Digit8">*</div>
<div class="key" data-code="Digit9">(</div>
<div class="key" data-code="Digit0">)</div>
<div class="key" data-code="Minus">_</div>
<div class="key" data-code="Equal">+</div>
<div class="key hot" data-code="Backspace">Backspace</div>
<div class="key hot" data-code="Tab">Tab</div>
<div class="key" data-code="KeyQ">q</div>
<div class="key" data-code="KeyW">w</div>
<div class="key" data-code="KeyE">e</div>
<div class="key" data-code="KeyR">r</div>
<div class="key" data-code="KeyT">t</div>
<div class="key" data-code="KeyY">y</div>
<div class="key" data-code="KeyU">u</div>
<div class="key" data-code="KeyI">i</div>
<div class="key" data-code="KeyO">o</div>
<div class="key" data-code="KeyP">p</div>
<div class="key" data-code="BracketLeft">{</div>
<div class="key" data-code="BracketRight">}</div>
<div class="key" data-code="Backslash">|</div>
<div class="key hot" data-code="Delete">DEL</div>
<div class="key hot" data-code="CapsLock">Caps Lock</div>
<div class="key" data-code="KeyA">a</div>
<div class="key" data-code="KeyS">s</div>
<div class="key" data-code="KeyD">d</div>
<div class="key" data-code="KeyF">f</div>
<div class="key" data-code="KeyG">g</div>
<div class="key" data-code="KeyH">h</div>
<div class="key" data-code="KeyJ">j</div>
<div class="key" data-code="KeyK">k</div>
<div class="key" data-code="KeyL">l</div>
<div class="key" data-code="Semicolon">:</div>
<div class="key" data-code="Quote">"</div>
<div class="key hot" data-code="Enter">ENTER</div>
<div class="key hot" data-code="ShiftLeft">Shift</div>
<div class="key" data-code="KeyZ">z</div>
<div class="key" data-code="KeyX">x</div>
<div class="key" data-code="KeyC">c</div>
<div class="key" data-code="KeyV">v</div>
<div class="key" data-code="KeyB">b</div>
<div class="key" data-code="KeyN">n</div>
<div class="key" data-code="KeyM">m</div>
<div class="key" data-code="Period">></div>
<div class="key" data-code="Comma"><</div>
<div class="key" data-code="Slash">?</div>
<div class="key hot" data-code="ArrowUp">△</div>
<div class="key hot" data-code="ShiftRight">Shift</div>
<div class="key hot" data-code="ControlLeft">Ctrl</div>
<div class="key hot" data-code="MetaLeft">Meta</div>
<div class="key hot" data-code="AltLeft">Alt</div>
<div class="key" data-code="Space"></div>
<div class="key hot" data-code="AltRight">Alt</div>
<div class="key hot" data-code="ControlRight">Ctrl</div>
<div class="key hot" data-code="ArrowLeft">◁</div>
<div class="key hot" data-code="ArrowDown">▽</div>
<div class="key hot" data-code="ArrowRight">▷</div>
`;

const keysRu = 
'<div class="key" data-code="Backquote">ё</div>   '+`
<div class="key" data-code="Digit1">1</div>
<div class="key" data-code="Digit2">2</div>
<div class="key" data-code="Digit3">3</div>
<div class="key" data-code="Digit4">4</div>
<div class="key" data-code="Digit5">5</div>
<div class="key" data-code="Digit6">6</div>
<div class="key" data-code="Digit7">7</div>
<div class="key" data-code="Digit8">8</div>
<div class="key" data-code="Digit9">9</div>
<div class="key" data-code="Digit0">0</div>
<div class="key" data-code="Minus">-</div>
<div class="key" data-code="Equal">=</div>
<div class="key hot" data-code="Backspace">Backspace</div>
<div class="key hot" data-code="Tab">Tab</div>
<div class="key" data-code="KeyQ">й</div>
<div class="key" data-code="KeyW">ц</div>
<div class="key" data-code="KeyE">у</div>
<div class="key" data-code="KeyR">к</div>
<div class="key" data-code="KeyT">е</div>
<div class="key" data-code="KeyY">н</div>
<div class="key" data-code="KeyU">г</div>
<div class="key" data-code="KeyI">ш</div>
<div class="key" data-code="KeyO">щ</div>
<div class="key" data-code="KeyP">з</div>
<div class="key" data-code="BracketLeft">х</div>
<div class="key" data-code="BracketRight">ъ</div> 
<div class="key" data-code="Backslash">\\</div> 
<div class="key hot" data-code="Delete">DEL</div>
<div class="key hot" data-code="CapsLock">Caps Lock</div>
<div class="key" data-code="KeyA">ф</div>
<div class="key" data-code="KeyS">ы</div>
<div class="key" data-code="KeyD">в</div>
<div class="key" data-code="KeyF">а</div>
<div class="key" data-code="KeyG">п</div>
<div class="key" data-code="KeyH">р</div>
<div class="key" data-code="KeyJ">о</div>
<div class="key" data-code="KeyK">л</div>
<div class="key" data-code="KeyL">д</div>
<div class="key" data-code="Semicolon">ж</div>
<div class="key" data-code="Quote">э</div>
<div class="key hot" data-code="Enter">ENTER</div>
<div class="key hot" data-code="ShiftLeft">Shift</div>
<div class="key" data-code="KeyZ">я</div>
<div class="key" data-code="KeyX">ч</div>
<div class="key" data-code="KeyC">с</div>
<div class="key" data-code="KeyV">м</div>
<div class="key" data-code="KeyB">и</div>
<div class="key" data-code="KeyN">т</div>
<div class="key" data-code="KeyM">ь</div>
<div class="key" data-code="Period">б</div>
<div class="key" data-code="Comma">ю</div>
<div class="key" data-code="Slash">.</div>
<div class="key hot" data-code="ArrowUp">△</div>
<div class="key hot" data-code="ShiftRight">Shift</div>
<div class="key hot" data-code="ControlLeft">Ctrl</div>
<div class="key hot" data-code="MetaLeft">Meta</div>
<div class="key hot" data-code="AltLeft">Alt</div>
<div class="key" data-code="Space"></div>
<div class="key hot" data-code="AltRight">Alt</div>
<div class="key hot" data-code="ControlRight">Ctrl</div>
<div class="key hot" data-code="ArrowLeft">◁</div>
<div class="key hot" data-code="ArrowDown">▽</div>
<div class="key hot" data-code="ArrowRight">▷</div>
`;

const keysRuShift = 
'<div class="key" data-code="Backquote">ё</div>   '+`
<div class="key" data-code="Digit1">!</div>
<div class="key" data-code="Digit2">"</div>
<div class="key" data-code="Digit3">№</div>
<div class="key" data-code="Digit4">;</div>
<div class="key" data-code="Digit5">%</div>
<div class="key" data-code="Digit6">:</div>
<div class="key" data-code="Digit7">?</div>
<div class="key" data-code="Digit8">*</div>
<div class="key" data-code="Digit9">(</div>
<div class="key" data-code="Digit0">)</div>
<div class="key" data-code="Minus">_</div>
<div class="key" data-code="Equal">+</div>
<div class="key hot" data-code="Backspace">Backspace</div>
<div class="key hot" data-code="Tab">Tab</div>
<div class="key" data-code="KeyQ">й</div>
<div class="key" data-code="KeyW">ц</div>
<div class="key" data-code="KeyE">у</div>
<div class="key" data-code="KeyR">к</div>
<div class="key" data-code="KeyT">е</div>
<div class="key" data-code="KeyY">н</div>
<div class="key" data-code="KeyU">г</div>
<div class="key" data-code="KeyI">ш</div>
<div class="key" data-code="KeyO">щ</div>
<div class="key" data-code="KeyP">з</div>
<div class="key" data-code="BracketLeft">х</div>
<div class="key" data-code="BracketRight">ъ</div> 
<div class="key" data-code="Backslash">/</div> 
<div class="key hot" data-code="Delete">DEL</div>
<div class="key hot" data-code="CapsLock">Caps Lock</div>
<div class="key" data-code="KeyA">ф</div>
<div class="key" data-code="KeyS">ы</div>
<div class="key" data-code="KeyD">в</div>
<div class="key" data-code="KeyF">а</div>
<div class="key" data-code="KeyG">п</div>
<div class="key" data-code="KeyH">р</div>
<div class="key" data-code="KeyJ">о</div>
<div class="key" data-code="KeyK">л</div>
<div class="key" data-code="KeyL">д</div>
<div class="key" data-code="Semicolon">ж</div>
<div class="key" data-code="Quote">э</div>
<div class="key hot" data-code="Enter">ENTER</div>
<div class="key hot" data-code="ShiftLeft">Shift</div>
<div class="key" data-code="KeyZ">я</div>
<div class="key" data-code="KeyX">ч</div>
<div class="key" data-code="KeyC">с</div>
<div class="key" data-code="KeyV">м</div>
<div class="key" data-code="KeyB">и</div>
<div class="key" data-code="KeyN">т</div>
<div class="key" data-code="KeyM">ь</div>
<div class="key" data-code="Period">б</div>
<div class="key" data-code="Comma">ю</div>
<div class="key" data-code="Slash">,</div>
<div class="key hot" data-code="ArrowUp">△</div>
<div class="key hot" data-code="ShiftRight">Shift</div>
<div class="key hot" data-code="ControlLeft">Ctrl</div>
<div class="key hot" data-code="MetaLeft">Meta</div>
<div class="key hot" data-code="AltLeft">Alt</div>
<div class="key" data-code="Space"></div>
<div class="key hot" data-code="AltRight">Alt</div>
<div class="key hot" data-code="ControlRight">Ctrl</div>
<div class="key hot" data-code="ArrowLeft">◁</div>
<div class="key hot" data-code="ArrowDown">▽</div>
<div class="key hot" data-code="ArrowRight">▷</div>
`;

const body = document.querySelector('body');
const keyboard = document.createElement('div');
keyboard.classList = 'kboard';
const textview = document.createElement('textarea');
textview.classList = 'textview';
const spec = document.createElement('p');
spec.classList = 'sometext';
spec.innerHTML = 'Windows, левые Ctrl+Alt,<br> свайп по шифту к любой кнопке = зафиксировать';

body.appendChild(textview);
body.appendChild(keyboard);
body.appendChild(spec);

let lang = 'en';

const toUpper = () => {
  keyboard.childNodes.forEach(key => {
    if (key.classList == 'key')  {
      key.textContent = key.textContent.toUpperCase();
    }
  });
}

const toLower = () => {
  keyboard.childNodes.forEach(key => {
    if (key.classList == 'key')  {
      key.textContent = key.textContent.toLowerCase();
    }
  });
}

let caps = false;

const capsEn = () =>  {
  if (caps === false) {
    caps = true;
    toUpper();
    document.querySelector('.key[data-code="CapsLock"]')
    .classList.add('active');
    return;
  }
  if (caps === true) {
    caps = false;
    toLower();
    document.querySelector('.key[data-code="CapsLock"]')
    .classList.remove('active');
    return;
  }
}

let shift = false;

const shiftEn = () =>  {
  if (shift === false) {
    keyboard.innerHTML = keysEnShift;
    if (caps === true) toLower();
    else toUpper();
    shift = true;
    return;
  }
  if (shift === true) {
    keyboard.innerHTML = keysEn;
    if (caps === true) toUpper();
    else toLower();
    shift = false;
    return;
  }
}

const shiftRu = () =>  {
  if (shift === false) {
    keyboard.innerHTML = keysRuShift;
    if (caps === true) toLower();
    else toUpper();
    shift = true;
    return;
  }
  if (shift === true) {
    keyboard.innerHTML = keysRu;
    if (caps === true) toUpper();
    else toLower();
    shift = false;
    return;
  }
}

const shiftThis = () =>  {
  if (lang === 'en') shiftEn();
  if (lang === 'ru') shiftRu();
}

const getCaret = () => { 
  if (textview.selectionStart) { 
    return textview.selectionStart; 
  } else if (document.selection) { 
    textview.focus(); 
    let r = document.selection.createRange(); 
    if (r == null) return 0; 
    let re = textview.createTextRange(), 
        rc = re.duplicate(); 
    re.moveToBookmark(r.getBookmark()); 
    rc.setEndPoint('EndToStart', re); 
    return rc.text.length; 
  }  
  return 0; 
}

const backspacePressed = () => {
  let pos = getCaret();
  if (pos === 0) return;
  textview.value = textview.value.substring(0, pos-1) +
   textview.value.substring(pos);
  textview.setSelectionRange(pos-1, pos-1);
  textview.focus();
}
const delPressed = () => {
  let pos = getCaret();
  textview.value = textview.value.substring(0, pos) +
   textview.value.substring(pos+1);
  textview.setSelectionRange(pos, pos);
  textview.focus();
}
const tabPressed = () => {
  let pos = getCaret();
  textview.value = textview.value.substring(0, pos) + '    ' +
   textview.value.substring(pos);
  textview.setSelectionRange(pos+4, pos+4);
  textview.focus();
}
const enterPressed = () => {
  let pos = getCaret();
  textview.value = textview.value.substring(0, pos) + '\n' 
  + textview.value.substring(pos);
  textview.setSelectionRange(pos+1, pos+1);
  textview.focus();
}
const spacePressed = () => {
  let pos = getCaret();
  if (pos !== textview.value.length) {
  textview.value = textview.value.substring(0, pos-1) + ' ' +
   textview.value.substring(pos-1);
  textview.setSelectionRange(pos, pos);
  } else {
  textview.value = textview.value.substring(0, pos) + ' ' +
   textview.value.substring(pos);
  textview.setSelectionRange(pos+1, pos+1);
  }
  textview.focus();
}
const someKeyPressed = (key) => {
  let pos = getCaret();
  textview.value = textview.value.substring(0, pos) + key +
   textview.value.substring(pos);
  textview.setSelectionRange(pos+1, pos+1);
  textview.focus();
}

////////              MOUSE
let mouseup = {
  shift : true,
  caps : true
}
keyboard.addEventListener('mousedown', e => { 
  if (e.target.dataset.code == 'ShiftLeft' ||
      e.target.dataset.code == 'ShiftRight') { // нажат ли шифт
    if  (mouseup.shift === false) return;
    shiftThis();
    mouseup.shift = false;
  }
  if (e.target.dataset.code == 'CapsLock') {   //  нажат ли капс
    if  (mouseup.caps === false) return;
    capsEn();
    document.querySelector('.key[data-code="CapsLock"]')
    .classList.add('active');
    mouseup.caps = false;
  }
  if (e.target.classList.value.indexOf('key') !== -1) {
    e.target.classList.add('active');
    
    if (e.target.dataset.code == 'Space') spacePressed();
    if (e.target.dataset.code == 'Backspace') backspacePressed();
    if (e.target.dataset.code == 'Delete') delPressed();
    if (e.target.dataset.code == 'Tab') tabPressed();
    if (e.target.dataset.code == 'Enter') enterPressed();
    else if (e.target.dataset.code == 'Space') {
      textview.value += ' ';
    } else if (e.target.classList.value.indexOf('hot') == -1 || 
              e.target.dataset.code == 'ArrowUp' ||
              e.target.dataset.code == 'ArrowLeft' ||
              e.target.dataset.code == 'ArrowDown' ||
              e.target.dataset.code == 'ArrowRight') {
      someKeyPressed(e.target.textContent);
    }
    if (e.target.dataset.code === 'CapsLock') {
      e.target.classList.add('active');
    }
  }

  
});
/////   MOUSE  UP
keyboard.addEventListener('mouseup', e => {
  document.querySelectorAll('.key').forEach(key => {
    key.classList.remove('active');
  });
  
  if (e.target.dataset.code == 'ShiftLeft' || e.target.dataset.code == 'ShiftRight') {
    shiftThis();
    mouseup.shift = true;
  }
  if (e.target.dataset.code == 'CapsLock') mouseup.caps = true;
  if (caps === true) document.querySelector('.key[data-code="CapsLock"]')
    .classList.add('active');
});
/////////          KEYBOARD

document.querySelector('.textview').addEventListener('keydown', e => {
  e.preventDefault();
});

let keyup = {
  shift : true,
  caps : true,
  ctrl : true,
  alt : true
}

document.addEventListener('keydown', e => {
  if (e.code == 'Tab'||  e.code == 'ArrowUp' ||
      e.code == 'ArrowLeft' || e.code == 'ArrowDown' ||
      e.code == 'ArrowRight') e.preventDefault();

  if (e.code == 'ShiftLeft' || e.code == 'ShiftRight') { // нажат ли шифт
    if  (keyup.shift === false) return;
    shiftThis();
    keyup.shift = false;
  }
  if (e.code == 'CapsLock') {   //  нажат ли капс
    if  (keyup.caps === false) return;
    capsEn();
    document.querySelector('.key[data-code="CapsLock"]')
    .classList.add('active');
    keyup.caps = false;
  }
  if (e.code == 'ControlLeft') { // нажат ли ктрл
    keyup.ctrl = false;
  }
  if (e.code == 'AltLeft') { // нажат ли ктрл
    keyup.alt = false;
  }
  if (keyup.ctrl === false && keyup.alt === false) {
    if (lang === 'en') {
      keyboard.innerHTML = keysRu;
      lang = 'ru';
      if (caps === true) toUpper();
    } else {
      keyboard.innerHTML = keysEn;
      lang = 'en';
      if (caps === true) toUpper();
    }
  }

  document.querySelectorAll('.key').forEach(key => {
    if (key.dataset.code == e.code) {
      key.classList.add('active');
      if (key.classList != 'key hot active' || 
          key.dataset.code == 'ArrowUp' ||
          key.dataset.code == 'ArrowLeft' ||
          key.dataset.code == 'ArrowDown' ||
          key.dataset.code == 'ArrowRight') {
            someKeyPressed(key.textContent);
      }
    }
  });

  if (e.code == 'Space') spacePressed();
  if (e.code == 'Backspace') backspacePressed();
  if (e.code == 'Delete') delPressed();
  if (e.code == 'Tab') tabPressed();
  if (e.code == 'Enter') enterPressed();
});
////////    KEY UP
document.addEventListener('keyup', e => {
  document.querySelectorAll('.key').forEach(key => {
    key.classList.remove('active');
  });
  
  if (e.code == 'ShiftLeft' || e.code == 'ShiftRight') {
    shiftThis();
    keyup.shift = true;
  }
  if (e.code == 'CapsLock') keyup.caps = true;
  if (e.code == 'AltLeft') keyup.alt = true;
  if (e.code == 'ControlLeft') keyup.ctrl = true;
  if (caps === true) document.querySelector('.key[data-code="CapsLock"]')
    .classList.add('active');
});

keyboard.innerHTML = keysEn;